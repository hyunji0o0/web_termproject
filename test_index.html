<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ í”¼íŠ¸ë‹ˆìŠ¤ íŒŒíŠ¸ë„ˆ - ì „ì²´ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</title>
    <!-- ìŠ¤íƒ€ì¼ë§ (CSS) -->
    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì„¤ì • */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #eef2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 400px; max-height: 95vh; overflow-y: auto; }
        
        /* íƒ€ì´í‹€ ë° í…ìŠ¤íŠ¸ */
        h2 { text-align: center; color: #333; margin-bottom: 1.5rem; font-size: 1.8rem; }
        p { color: #666; margin-bottom: 10px; }
        
        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: #007bff; outline: none; }
        
        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-bottom: 8px; font-size: 1rem; }
        
        /* ë²„íŠ¼ ìƒ‰ìƒë³„ ìŠ¤íƒ€ì¼ */
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; color: white; margin-top: 15px; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-outline { background-color: transparent; border: 1px solid #007bff; color: #007bff; margin-top: 5px; }
        .btn-outline:hover { background-color: #f0f8ff; }
        
        /* ë©”ì‹œì§€ ë° ìœ í‹¸ë¦¬í‹° */
        #message { margin-top: 15px; font-size: 0.9rem; text-align: center; min-height: 20px; padding: 10px; border-radius: 5px; }
        .hidden { display: none !important; }
        .row { display: flex; gap: 10px; } /* ì…ë ¥ì°½ ê°€ë¡œ ë°°ì¹˜ìš© */
        .row input, .row select { flex: 1; }
        .divider { border-top: 1px solid #eee; margin: 20px 0; }
        
        /* ëŒ€ì‹œë³´ë“œ ì •ë³´ ì¹´ë“œ */
        .info-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; line-height: 1.6; }
        .info-label { color: #888; font-size: 0.85rem; }
        .info-value { font-weight: bold; color: #333; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="page-title">ğŸ’ª Fitness Partner</h2>

        <!-- ========================================== -->
        <!-- 1. ë¡œê·¸ì¸ í™”ë©´ (Login View) -->
        <!-- ========================================== -->
        <div id="login-view">
            <input type="email" id="login-email" placeholder="ì´ë©”ì¼ (ì˜ˆ: user@naver.com)" value="hanbin9570@naver.com">
            <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="1234">
            
            <button class="btn-primary" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <button class="btn-outline" onclick="switchView('signup')">íšŒì›ê°€ì… í•˜ëŸ¬ê°€ê¸°</button>
        </div>

        <!-- ========================================== -->
        <!-- 2. íšŒì›ê°€ì… í™”ë©´ (Signup View) -->
        <!-- ========================================== -->
        <div id="signup-view" class="hidden">
            <input type="email" id="reg-email" placeholder="ì´ë©”ì¼ (í•„ìˆ˜)">
            <input type="password" id="reg-password" placeholder="ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)">
            <input type="text" id="reg-name" placeholder="ì´ë¦„ (í•„ìˆ˜)">
            
            <div class="row">
                <input type="number" id="reg-height" placeholder="í‚¤ (cm)">
                <input type="number" id="reg-weight" placeholder="ëª¸ë¬´ê²Œ (kg)">
            </div>
            
            <div class="row">
                <input type="number" id="reg-age" placeholder="ë‚˜ì´">
                <select id="reg-gender">
                    <option value="male">ë‚¨ì„±</option>
                    <option value="female">ì—¬ì„±</option>
                </select>
            </div>

            <button class="btn-success" onclick="handleRegister()">íšŒì›ê°€ì… & ì¸ì¦ë©”ì¼ ë°œì†¡</button>
            <button class="btn-outline" onclick="switchView('login')">ì·¨ì†Œí•˜ê³  ë¡œê·¸ì¸ìœ¼ë¡œ</button>
        </div>

        <!-- ========================================== -->
        <!-- 3. ì´ë©”ì¼ ì¸ì¦ í™”ë©´ (Verify View) -->
        <!-- ========================================== -->
        <div id="verify-view" class="hidden">
            <p style="text-align:center;">
                <strong id="verify-target-email"></strong><br>
                ìœ„ ë©”ì¼ë¡œ ì „ì†¡ëœ 6ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.
            </p>
            <input type="text" id="verify-code" placeholder="ì¸ì¦ì½”ë“œ 6ìë¦¬" style="text-align: center; letter-spacing: 5px; font-size: 1.5rem;" maxlength="6">
            
            <button class="btn-success" onclick="handleVerify()">ì¸ì¦ í™•ì¸</button>
            <button class="btn-outline" onclick="switchView('signup')">ë’¤ë¡œ ê°€ê¸°</button>
        </div>

        <!-- ========================================== -->
        <!-- 4. ëŒ€ì‹œë³´ë“œ í™”ë©´ (Dashboard View) -->
        <!-- ========================================== -->
        <div id="dashboard-view" class="hidden">
            <div id="user-info-area" class="info-card">
                <!-- ì‚¬ìš©ì ì •ë³´ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                ë°ì´í„° ë¡œë”© ì¤‘...
            </div>
            
            <div class="divider"></div>
            
            <button class="btn-primary" onclick="fetchUserInfo()">ğŸ”„ ì •ë³´ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn-danger" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
        <div id="message" class="hidden"></div>
    </div>

    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ -->
    <script>
        const API_URL = '.'; // PHP íŒŒì¼ë“¤ì´ ìˆëŠ” í˜„ì¬ ê²½ë¡œ

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        window.onload = () => {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                switchView('dashboard');
                fetchUserInfo();
            } else {
                switchView('login');
            }
        };

        // 2. í™”ë©´ ì „í™˜ í•¨ìˆ˜ (SPA ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨)
        function switchView(viewName) {
            // ëª¨ë“  í™”ë©´ ìˆ¨ê¸°ê¸°
            ['login-view', 'signup-view', 'verify-view', 'dashboard-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            // ì„ íƒí•œ í™”ë©´ ë³´ì´ê¸°
            document.getElementById(viewName + '-view').classList.remove('hidden');
            
            // ë©”ì‹œì§€ ì°½ ì´ˆê¸°í™”
            hideMessage();

            // íƒ€ì´í‹€ ë³€ê²½
            const titles = {
                'login': 'ğŸ’ª ë¡œê·¸ì¸',
                'signup': 'ğŸ“ íšŒì›ê°€ì…',
                'verify': 'ğŸ“§ ì´ë©”ì¼ ì¸ì¦',
                'dashboard': 'ğŸ  ë§ˆì´ í˜ì´ì§€'
            };
            document.getElementById('page-title').innerText = titles[viewName] || 'Fitness Partner';
        }

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 1] íšŒì›ê°€ì… ë° ë©”ì¼ ë°œì†¡ (Register Flow)
        // ---------------------------------------------------------
        async function handleRegister() {
            // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
            const userData = {
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                name: document.getElementById('reg-name').value,
                height: document.getElementById('reg-height').value,
                weight: document.getElementById('reg-weight').value,
                age: document.getElementById('reg-age').value,
                gender: document.getElementById('reg-gender').value
            };

            if (!userData.email || !userData.password || !userData.name) {
                return showMessage('ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.', 'red');
            }

            showMessage('íšŒì›ì •ë³´ ì €ì¥ ì¤‘...', 'blue');

            try {
                // 1ë‹¨ê³„: DBì— íšŒì›ì •ë³´ ì €ì¥ (register.php)
                let res = await fetch(`${API_URL}/register.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
                let data = await res.json();

                if (!data.success) throw new Error(data.message);

                // 2ë‹¨ê³„: ì¸ì¦ ë©”ì¼ ë°œì†¡ (send-verification.php)
                showMessage('ê°€ì… ì„±ê³µ! ì¸ì¦ ë©”ì¼ ë°œì†¡ ì¤‘...', 'blue');
                
                res = await fetch(`${API_URL}/send-verification.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userData.email })
                });
                data = await res.json();

                if (data.success) {
                    // ì„±ê³µ ì‹œ ì¸ì¦ í™”ë©´ìœ¼ë¡œ ì´ë™
                    document.getElementById('verify-target-email').innerText = userData.email;
                    switchView('verify');
                    showMessage('âœ… ì¸ì¦ ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'green');
                } else {
                    throw new Error('ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + data.message);
                }

            } catch (err) {
                showMessage('âŒ ì˜¤ë¥˜: ' + err.message, 'red');
            }
        }

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 2] ì¸ì¦ ì½”ë“œ í™•ì¸ (Verify)
        // ---------------------------------------------------------
        async function handleVerify() {
            // ê°€ì… í™”ë©´ì— ì…ë ¥í–ˆë˜ ì´ë©”ì¼ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const email = document.getElementById('reg-email').value; 
            const code = document.getElementById('verify-code').value;

            if (!code || code.length < 6) {
                return showMessage('6ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'red');
            }

            try {
                const res = await fetch(`${API_URL}/verify.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const data = await res.json();

                if (data.success) {
                    alert('ì¸ì¦ ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    switchView('login');
                    // ë¡œê·¸ì¸ í¸ì˜ë¥¼ ìœ„í•´ ì´ë©”ì¼ ìë™ ì…ë ¥
                    document.getElementById('login-email').value = email;
                    document.getElementById('login-password').value = '';
                    document.getElementById('login-password').focus();
                } else {
                    showMessage('âŒ ' + data.message, 'red');
                }
            } catch (err) {
                showMessage('âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜', 'red');
            }
        }

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 3] ë¡œê·¸ì¸ (Login)
        // ---------------------------------------------------------
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if(!email || !password) return showMessage('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'red');

            showMessage('ë¡œê·¸ì¸ ì¤‘...', 'blue');

            try {
                const res = await fetch(`${API_URL}/login.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (data.success) {
                    // í† í° ì €ì¥ (í•µì‹¬!)
                    localStorage.setItem('jwt_token', data.token);
                    switchView('dashboard');
                    fetchUserInfo();
                } else {
                    showMessage('âŒ ' + data.message, 'red');
                }
            } catch (err) {
                showMessage('âŒ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'red');
            }
        }

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 4] ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (Protected Route)
        // ---------------------------------------------------------
        async function fetchUserInfo() {
            const token = localStorage.getItem('jwt_token');
            if (!token) return handleLogout();

            try {
                const res = await fetch(`${API_URL}/request_user_info.php`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}` // JWT í† í° ì œì¶œ
                    }
                });
                const data = await res.json();

                if (data.success) {
                    const u = data.data;
                    // í™”ë©´ ê°±ì‹ 
                    document.getElementById('user-info-area').innerHTML = `
                        <div class="info-label">ì´ë¦„</div>
                        <div class="info-value">${u.name}</div>
                        <br>
                        <div class="info-label">ì´ë©”ì¼</div>
                        <div class="info-value">${u.email}</div>
                        <br>
                        <div class="info-label">ì‹ ì²´ ì •ë³´</div>
                        <div class="info-value">${u.height}cm / ${u.weight}kg / ${u.age}ì„¸ (${u.gender})</div>
                        <br>
                        <div class="info-label">ê³„ì • ìƒíƒœ</div>
                        <div class="info-value" style="color:green;">âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œë¨</div>
                    `;
                    showMessage('ì •ë³´ê°€ ìµœì‹ ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'green');
                } else {
                    // í† í° ë§Œë£Œë‚˜ ë¡œê·¸ì•„ì›ƒëœ í† í°ì¸ ê²½ìš°
                    showMessage('âš ï¸ ' + data.message, 'orange');
                    if (res.status === 401) {
                        setTimeout(handleLogout, 2000); // 2ì´ˆ ë’¤ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    }
                }
            } catch (err) {
                console.error(err);
            }
        }

        // ---------------------------------------------------------
        // [ê¸°ëŠ¥ 5] ë¡œê·¸ì•„ì›ƒ (Logout)
        // ---------------------------------------------------------
        async function handleLogout() {
            const token = localStorage.getItem('jwt_token');
            if (token) {
                try {
                    // ì„œë²„ì— ë¡œê·¸ì•„ì›ƒ ìš”ì²­ (ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë“±ë¡)
                    await fetch(`${API_URL}/logout.php`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (e) { console.error(e); }
            }

            // í´ë¼ì´ì–¸íŠ¸ í† í° ì‚­ì œ
            localStorage.removeItem('jwt_token');
            switchView('login');
            showMessage('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'gray');
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text, color) {
            const el = document.getElementById('message');
            el.textContent = text;
            el.style.backgroundColor = color === 'red' ? '#ffeaea' : (color === 'green' ? '#eaffea' : '#eef2f5');
            el.style.color = color === 'gray' ? '#666' : color;
            el.classList.remove('hidden');
        }

        function hideMessage() {
            document.getElementById('message').classList.add('hidden');
        }
    </script>
</body>
</html>